<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>記事詳細</title>
    <link rel="stylesheet" href="/assets/styles.css" />
    <!-- Markdown パーサ（index と同じものを利用）-->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <main id="postContainer"></main>
    <script>
      // GitHub リポジトリ設定（index.html と同じ値にしてください）
      const REPO_OWNER = 'your-github-username';
      const REPO_NAME = 'your-repo-name';
      const BRANCH = 'main';

      /**
       * YAML の簡易パーサ。同一コードを index.html からコピー
       */
      function parseYAML(yaml) {
        const lines = yaml.split('\n');
        const obj = {};
        for (const line of lines) {
          const idx = line.indexOf(':');
          if (idx > -1) {
            const key = line.slice(0, idx).trim();
            let value = line.slice(idx + 1).trim();
            if (
              (value.startsWith('"') && value.endsWith('"')) ||
              (value.startsWith("'") && value.endsWith("'"))
            ) {
              value = value.slice(1, -1);
            }
            if (/^\d{4}-\d{2}-\d{2}/.test(value)) {
              obj[key] = value;
            } else if (value === 'true' || value === 'false') {
              obj[key] = value === 'true';
            } else if (value.startsWith('[') && value.endsWith(']')) {
              const list = value
                .slice(1, -1)
                .split(',')
                .map((s) => s.trim().replace(/^['"]|['"]$/g, ''))
                .filter(Boolean);
              obj[key] = list;
            } else {
              obj[key] = value;
            }
          }
        }
        return obj;
      }

      /**
       * フロントマターと本文を分割します。
       */
      function parseFrontMatter(content) {
        const fmRegex = /^---\n([\s\S]*?)\n---\n?/;
        const match = content.match(fmRegex);
        let metadata = {};
        let body = content;
        if (match) {
          const yaml = match[1];
          body = content.slice(match[0].length);
          metadata = parseYAML(yaml);
        }
        return { ...metadata, body };
      }

      /**
       * メタタグを動的に更新します。OGP/Twitterカードに対応。
       */
      function updateMetaTags(post) {
        const description = post.excerpt || '';
        const eyecatchUrl = post.eyecatch
          ? post.eyecatch.startsWith('http')
            ? post.eyecatch
            : `${window.location.origin}/assets/uploads/${post.eyecatch}`
          : '';
        setMeta('description', description);
        setMeta('og:title', post.title || '');
        setMeta('og:description', description);
        if (eyecatchUrl) {
          setMeta('og:image', eyecatchUrl);
          setMeta('twitter:card', 'summary_large_image');
          setMeta('twitter:image', eyecatchUrl);
        } else {
          setMeta('twitter:card', 'summary');
        }
      }

      function setMeta(name, content) {
        let meta = document.querySelector(
          `meta[name="${name}"],meta[property="${name}"]`
        );
        if (!meta) {
          meta = document.createElement('meta');
          if (name.startsWith('og:')) meta.setAttribute('property', name);
          else meta.setAttribute('name', name);
          document.head.appendChild(meta);
        }
        meta.setAttribute('content', content);
      }

      /**
       * URL パラメータから path を取得して記事を読み込みます。
       */
      async function loadPost() {
        const params = new URLSearchParams(window.location.search);
        const path = params.get('path');
        const container = document.getElementById('postContainer');
        if (!path) {
          container.textContent = '記事パスが指定されていません。';
          return;
        }
        const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}?ref=${BRANCH}`;
        const res = await fetch(apiUrl);
        if (!res.ok) {
          container.textContent = '記事を取得できませんでした。';
          return;
        }
        const data = await res.json();
        // Base64 データをデコードする。API は改行を含むので除去
        const decoded = atob(data.content.replace(/\n/g, ''));
        const post = parseFrontMatter(decoded);
        container.innerHTML = '';
        // タイトル
        if (post.title) {
          document.title = post.title;
        }
        updateMetaTags(post);
        const header = document.createElement('header');
        const h1 = document.createElement('h1');
        h1.textContent = post.title || '';
        header.appendChild(h1);
        if (post.date) {
          const timeElem = document.createElement('time');
          timeElem.dateTime = post.date;
          try {
            timeElem.textContent = new Date(post.date).toLocaleDateString('ja-JP');
          } catch (e) {
            timeElem.textContent = post.date;
          }
          header.appendChild(timeElem);
        }
        container.appendChild(header);
        // アイキャッチ
        if (post.eyecatch) {
          const img = document.createElement('img');
          img.className = 'post-eyecatch';
          img.src = post.eyecatch.startsWith('http')
            ? post.eyecatch
            : `/assets/uploads/${post.eyecatch}`;
          img.alt = post.title || '';
          container.appendChild(img);
        }
        // タグ
        if (post.tags) {
          const tagsDiv = document.createElement('div');
          tagsDiv.className = 'post-tags';
          const tags = Array.isArray(post.tags) ? post.tags : [post.tags];
          tags.forEach((tag) => {
            const span = document.createElement('span');
            span.className = 'tag';
            span.textContent = tag;
            span.onclick = () => {
              window.location.href = `/index.html?tag=${encodeURIComponent(tag)}`;
            };
            tagsDiv.appendChild(span);
          });
          container.appendChild(tagsDiv);
        }
        // 本文
        const article = document.createElement('article');
        article.className = 'post-body';
        article.innerHTML = marked.parse(post.body || '');
        container.appendChild(article);
      }

      loadPost().catch((err) => {
        document.getElementById('postContainer').textContent =
          '読み込み中にエラーが発生しました。';
        console.error(err);
      });
    </script>
  </body>
</html>

