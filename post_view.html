<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>記事詳細</title>
    <link rel="stylesheet" href="/assets/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <main id="postContainer"></main>
    <!-- 診断用（不要になったら消してOK） -->
    <div id="diag" style="padding:8px;border:1px solid #ccc;margin:8px;white-space:pre-wrap;"></div>

    <script>
      const REPO_OWNER = 'Tomohiro0615';
      const REPO_NAME  = 'usmle-blog';
      const BRANCH = 'main';
      const diag = document.getElementById('diag');

      /* Base64 → UTF-8（堅牢版） */
      function base64ToUtf8String(b64) {
        const binary = atob((b64 || '').replace(/\n/g, ''));
        if (window.TextDecoder) {
          const bytes = new Uint8Array(binary.length);
          for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
          try { return new TextDecoder('utf-8', { fatal: false }).decode(bytes); } catch {}
        }
        try { return decodeURIComponent(escape(binary)); } catch { return binary; }
      }

      async function githubGetFileUtf8(path) {
        path = path.replace(/^\/+/, '');
        const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}?ref=${BRANCH}`;
        const r = await fetch(url);
        const text = await r.text();
        if (!r.ok) throw new Error(`Get file NG ${r.status}: ${text}`);
        const data = JSON.parse(text);
        return base64ToUtf8String(data.content);
      }

      function parseYAML(yaml) {
        const lines = (yaml || '').split('\n');
        const obj = {};
        for (const line of lines) {
          if (!line || !line.includes(':')) continue;
          const idx = line.indexOf(':');
          const key = line.slice(0, idx).trim();
          let value = line.slice(idx + 1).trim();
          if ((value.startsWith('"') && value.endsWith('"')) || (value.startsWith("'") && value.endsWith("'"))) {
            value = value.slice(1, -1);
          }
          if (/^\d{4}-\d{2}-\d{2}/.test(value)) obj[key] = value;
          else if (value === 'true' || value === 'false') obj[key] = (value === 'true');
          else if (value.startsWith('[') && value.endsWith(']')) {
            obj[key] = value.slice(1, -1).split(',')
              .map(s => s.trim().replace(/^['"]|['"]$/g, '')).filter(Boolean);
          } else obj[key] = value;
        }
        return obj;
      }

      function parseFrontMatter(content) {
        const fmRegex = /^---\n([\s\S]*?)\n---\n?/;
        const match = content.match(fmRegex);
        let metadata = {};
        let body = content || '';
        if (match) {
          const yaml = match[1];
          body = content.slice(match[0].length);
          metadata = parseYAML(yaml);
        }
        return { ...metadata, body };
      }

      function setMeta(name, content) {
        let meta = document.querySelector(`meta[name="${name}"],meta[property="${name}"]`);
        if (!meta) {
          meta = document.createElement('meta');
          if (name.startsWith('og:')) meta.setAttribute('property', name);
          else meta.setAttribute('name', name);
          document.head.appendChild(meta);
        }
        meta.setAttribute('content', content);
      }

      function updateMetaTags(post) {
        const description = post.excerpt || '';
        const eyecatchUrl = post.eyecatch
          ? (post.eyecatch.startsWith('http') ? post.eyecatch : `${window.location.origin}/assets/uploads/${post.eyecatch}`)
          : '';
        setMeta('description', description);
        setMeta('og:title', post.title || '');
        setMeta('og:description', description);
        if (eyecatchUrl) {
          setMeta('og:image', eyecatchUrl);
          setMeta('twitter:card', 'summary_large_image');
          setMeta('twitter:image', eyecatchUrl);
        } else {
          setMeta('twitter:card', 'summary');
        }
      }

      async function loadPost() {
        const params = new URLSearchParams(window.location.search);
        let path = params.get('path');
        const container = document.getElementById('postContainer');
        if (!path) {
          container.textContent = '記事パスが指定されていません。';
          return;
        }
        try {
          diag.textContent = `診断: 取得開始 path=${path}`;
          const raw = await githubGetFileUtf8(path);
          const post = parseFrontMatter(raw);
          container.innerHTML = '';
          if (post.title) document.title = post.title;
          updateMetaTags(post);

          const header = document.createElement('header');
          const h1 = document.createElement('h1');
          h1.textContent = post.title || '';
          header.appendChild(h1);

          if (post.date) {
            const timeElem = document.createElement('time');
            timeElem.dateTime = post.date;
            try { timeElem.textContent = new Date(post.date).toLocaleDateString('ja-JP'); }
            catch { timeElem.textContent = post.date; }
            header.appendChild(timeElem);
          }
          container.appendChild(header);

          if (post.eyecatch) {
            const img = document.createElement('img');
            img.className = 'post-eyecatch';
            img.src = post.eyecatch.startsWith('http') ? post.eyecatch : `/assets/uploads/${post.eyecatch}`;
            img.alt = post.title || '';
            img.onerror = () => img.remove();
            container.appendChild(img);
          }

          if (post.tags) {
            const tagsDiv = document.createElement('div');
            tagsDiv.className = 'post-tags';
            const tags = Array.isArray(post.tags) ? post.tags : [post.tags];
            tags.forEach(tag => {
              const span = document.createElement('span');
              span.className = 'tag';
              span.textContent = tag;
              span.onclick = () => {
                window.location.href = `/index.html?tag=${encodeURIComponent(tag)}`;
              };
              tagsDiv.appendChild(span);
            });
            container.appendChild(tagsDiv);
          }

          const article = document.createElement('article');
          article.className = 'post-body';
          article.innerHTML = marked.parse(post.body || '');
          container.appendChild(article);

          diag.textContent = `診断: 取得/描画OK`;
        } catch (e) {
          diag.textContent = `診断: 失敗 ${e.message}`;
          container.textContent = '記事を取得できませんでした。';
        }
      }

      loadPost();
    </script>
  </body>
</html>