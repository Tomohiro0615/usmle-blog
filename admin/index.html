<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>サイト管理</title>

    <!-- 1) まず CMS の設定を「グローバル変数」に内蔵（Decap が自動で拾います） -->
    <script>
      window.CMS_CONFIG = {
        load_config_file: false,
        config: {
          backend: { name: 'git-gateway', branch: 'main' },
          media_folder: 'assets/uploads',
          public_folder: '/assets/uploads',
          locale: 'ja',
          publish_mode: 'editorial_workflow',
          site_url: 'https://usmle-japan-blog.netlify.app',
          display_url: 'https://usmle-japan-blog.netlify.app',
          collections: [
            {
              name: 'posts',
              label: '投稿',
              label_singular: '投稿',
              folder: 'posts',
              create: true,
              extension: 'md',
              slug: '{{year}}{{month}}{{day}}-{{slug}}',
              sort: 'date:desc',
              preview_path: 'post_view.html?path=/posts/{{filename}}',
              fields: [
                { label: 'タイトル', name: 'title', widget: 'string', required: true },
                { label: '日付', name: 'date', widget: 'datetime', format: 'YYYY-MM-DD', time_format: false, required: true },
                { label: '抜粋（一覧に表示）', name: 'excerpt', widget: 'text', required: false },
                { label: 'タグ', name: 'tags', widget: 'list', required: false },
                { label: 'アイキャッチ画像', name: 'eyecatch', widget: 'image', required: false, allow_multiple: false },
                { label: '下書き', name: 'draft', widget: 'boolean', default: false, required: false },
                { label: '本文（Markdown）', name: 'body', widget: 'markdown', required: false }
              ],
            },
          ],
        }
      };
    </script>

    <!-- 2) Netlify Identity（ログインUI用。イベントハンドラは付けません＝リロードしません） -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <!-- 3) Decap CMS 本体（どちらか読めればOK） -->
    <script src="https://unpkg.com/decap-cms@^3/dist/decap-cms.js"></script>
    <script>
      // 予備CDN（unpkgがブロックされた時の保険）
      setTimeout(() => {
        if (!window.CMS) {
          var s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/decap-cms@3/dist/decap-cms.js';
          document.head.appendChild(s);
        }
      }, 1000);
    </script>

    <!-- プレビューにサイトのCSSを適用（なくてもOK） -->
    <link rel="stylesheet" href="/assets/styles.css" />
    <style>body{margin:0}</style>
  </head>
  <body>
    <noscript>JavaScript を有効にしてください。</noscript>
  </body>
</html>