<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>管理画面（ロード診断つき）</title>
  <link rel="stylesheet" href="/assets/styles.css" />
  <style>
    body{margin:0}
    .wrap{max-width:760px;margin:24px auto;padding:16px}
    .card{border:1px solid #ccc;border-radius:8px;padding:16px;margin:12px 0}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap}
    .ok{color:#0a7f00;font-weight:600}
    .ng{color:#b00020;font-weight:600}
  </style>

  <!-- CMS設定（外部config.ymlは使わない） -->
  <script>
    window.CMS_CONFIG = {
      load_config_file: false,
      config: {
        backend: { name: 'git-gateway', branch: 'main' },
        media_folder: 'assets/uploads',
        public_folder: '/assets/uploads',
        locale: 'ja',
        publish_mode: 'editorial_workflow',
        site_url: 'https://usmle-japan-blog.netlify.app',
        display_url: 'https://usmle-japan-blog.netlify.app',
        collections: [
          {
            name: 'posts', label: '投稿', label_singular: '投稿',
            folder: 'posts', create: true, extension: 'md',
            slug: '{{year}}{{month}}{{day}}-{{slug}}', sort: 'date:desc',
            preview_path: 'post_view.html?path=/posts/{{filename}}',
            fields: [
              { label:'タイトル', name:'title', widget:'string', required:true },
              { label:'日付', name:'date', widget:'datetime', format:'YYYY-MM-DD', time_format:false, required:true },
              { label:'抜粋（一覧に表示）', name:'excerpt', widget:'text' },
              { label:'タグ', name:'tags', widget:'list' },
              { label:'アイキャッチ画像', name:'eyecatch', widget:'image', allow_multiple:false },
              { label:'下書き', name:'draft', widget:'boolean', default:false },
              { label:'本文（Markdown）', name:'body', widget:'markdown' }
            ]
          }
        ]
      }
    };
  </script>
</head>
<body>
  <div class="wrap">
    <h1>管理画面</h1>
    <div class="card mono" id="log">起動中…</div>
    <div class="card">状態: <span id="st">初期化</span></div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    const stEl  = document.getElementById('st');
    const log = (m, cls)=>{const d=document.createElement('div'); if(cls)d.className=cls; d.textContent=m; logEl.appendChild(d);};
    const setSt = (t)=> stEl.textContent=t;

    function loadScript(src,label){
      return new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src=src; s.crossOrigin='anonymous';
        s.onload=()=>{ log(`LOAD OK: ${label}`,'ok'); res(); };
        s.onerror=()=>{ log(`LOAD NG: ${label} (${src})`,'ng'); rej(new Error(label)); };
        document.head.appendChild(s);
      });
    }

    (async () => {
      log('STEP1: 設定内蔵OK','ok');

      // 1) Identity Widget を unpkg から読み込み → ダメなら公式にフォールバック
      try{
        setSt('Identity読込中（unpkg）…');
        await loadScript('https://unpkg.com/netlify-identity-widget@1.10.1/build/netlify-identity-widget.js','Identity Widget (unpkg)');
      }catch(e){
        setSt('Identity読込中（official）…');
        try{
          await loadScript('https://identity.netlify.com/v1/netlify-identity-widget.js','Identity Widget (official)');
        }catch(e2){
          log('Identity が読めません（CSP/回線をご確認）','ng');
        }
      }

      // 2) Netlify CMS v2（安定版）
      try{
        setSt('CMS本体読込中（unpkg）…');
        await loadScript('https://unpkg.com/netlify-cms@2.10.192/dist/netlify-cms.js','Netlify CMS v2 (unpkg)');
      }catch(e){
        setSt('CMS本体読込中（jsDelivr）…');
        await loadScript('https://cdn.jsdelivr.net/npm/netlify-cms@2.10.192/dist/netlify-cms.js','Netlify CMS v2 (jsDelivr)');
      }

      // 3) 起動
      setSt('CMS初期化中…');
      let tries=0;
      const t=setInterval(()=>{
        tries++;
        if(window.CMS && typeof window.CMS.init==='function'){
          clearInterval(t);
          try{
            window.CMS.registerPreviewStyle('/assets/styles.css');
            window.CMS.init(window.CMS_CONFIG);
            setSt('CMS起動OK（左にUIが表示されます）');
            log('STEP3: CMS.init() 実行','ok');
          }catch(e){
            setSt('CMS初期化エラー'); log('CMS.init エラー: '+(e.stack||e.message),'ng');
          }
        }else if(tries>20){
          clearInterval(t);
          setSt('CMSが見つかりません'); log('window.CMS 未検出','ng');
        }
      },400);
    })();

    window.addEventListener('error', (e)=> log('window.error: '+e.message,'ng'));
    window.addEventListener('unhandledrejection', (e)=> log('unhandledrejection: '+(e.reason&&e.reason.message),'ng'));
  </script>
</body>
</html>