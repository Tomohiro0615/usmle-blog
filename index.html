<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>USMLE Japan Blog</title>
<link rel="stylesheet" href="/assets/styles.css">
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;line-height:1.6;background:var(--bg,#fff);color:var(--fg,#111)}
  header{padding:20px 16px;border-bottom:1px solid #e5e7eb}
  main{max-width:900px;margin:0 auto;padding:16px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
  input[type="search"]{flex:1;min-width:220px;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
  .tag{display:inline-block;padding:2px 8px;border:1px solid #cbd5e1;border-radius:999px;font-size:12px;margin-right:6px}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:12px 0}
  .meta{font-size:12px;color:#6b7280;margin-bottom:6px}
  .err{background:#fff3f3;border:1px solid #f3c2c2;color:#b10707;padding:10px;border-radius:8px;margin:12px 0}
  @media (prefers-color-scheme: dark){
    :root{--bg:#0b0f14;--fg:#e5e7eb}
    header, .card{border-color:#1f2937}
    input[type="search"]{background:#0b0f14;color:#e5e7eb;border-color:#374151}
  }
</style>
</head>
<body>
<header>
  <main>
    <h1 style="margin:0 0 4px">USMLE Japan Blog</h1>
    <div class="toolbar">
      <input id="q" type="search" placeholder="検索（タイトル/抜粋/タグ）">
      <div id="tags"></div>
      <a class="tag" href="/admin/">管理画面</a>
    </div>
  </main>
</header>

<main>
  <div id="status" class="err" style="display:none"></div>
  <div id="list"></div>
</main>

<script>
const OWNER = 'Tomohiro0615';
const REPO  = 'usmle-blog';
const BRANCH = 'main';

const listEl = document.getElementById('list');
const statusEl = document.getElementById('status');
const qEl = document.getElementById('q');
const tagsEl = document.getElementById('tags');

let allPosts = [];
let currentTag = null;

function showErr(msg){
  statusEl.style.display = 'block';
  statusEl.textContent = msg;
}

async function j(url){ const r = await fetch(url, {cache:'no-store'}); if(!r.ok) throw new Error(`${r.status} ${url}`); return r.json(); }
async function t(url){ const r = await fetch(url, {cache:'no-store'}); if(!r.ok) throw new Error(`${r.status} ${url}`); return r.text(); }

function parseFrontMatter(mdRaw){
  // UTF-8 BOM除去
  const md = mdRaw.replace(/^\uFEFF/, '');
  const m = md.match(/^---\r?\n([\s\S]*?)\r?\n---\r?\n?/);
  if(!m) return { data:{}, body: md };
  const yaml = m[1];
  const body = md.slice(m[0].length);
  const data = {};
  yaml.split(/\r?\n/).forEach(line=>{
    const mm = line.match(/^([A-Za-z0-9_]+):\s*(.*)$/);
    if(!mm) return;
    const k = mm[1].trim();
    let v = mm[2].trim();
    if (v === 'true') v = true;
    else if (v === 'false') v = false;
    else if (v.startsWith('[') && v.endsWith(']')) {
      try { v = JSON.parse(v.replace(/([^\s"',\[\]]+)/g,'"$1"')); } catch(e){}
    } else {
      v = v.replace(/^"(.*)"$/,'$1');
    }
    data[k] = v;
  });
  return { data, body };
}

function render(){
  // フィルタ（ドラフト非表示）
  let posts = allPosts.filter(p => !p.data.draft);
  if (currentTag) posts = posts.filter(p => (p.data.tags||[]).includes(currentTag));
  const q = (qEl.value||'').trim().toLowerCase();
  if (q) {
    posts = posts.filter(p=>{
      const hay = `${p.data.title||''} ${p.data.excerpt||''} ${(p.data.tags||[]).join(' ')}`.toLowerCase();
      return hay.includes(q);
    });
  }
  // 日付降順
  posts.sort((a,b)=> (b.data.date||'').localeCompare(a.data.date||''));

  // 描画
  if (!posts.length) {
    listEl.innerHTML = '<p>表示できる記事がありません（下書きのみ もしくは 取得失敗）。</p>';
    return;
  }
  listEl.innerHTML = posts.map(p=>`
    <article class="card">
      <div class="meta">${p.data.date||''} ${(p.data.tags||[]).map(x=>`<span class="tag">${x}</span>`).join('')}</div>
      <h2 style="margin:.2em 0;"><a href="/post_view.html?path=/posts/${encodeURIComponent(p.name)}">${p.data.title||p.name}</a></h2>
      <p>${p.data.excerpt||''}</p>
    </article>
  `).join('');

  // タグ一覧（初回のみ）
  if (!tagsEl.dataset.ready) {
    const set = new Set();
    posts.forEach(p => (p.data.tags||[]).forEach(t => set.add(t)));
    tagsEl.innerHTML = ['すべて', ...Array.from(set)].map(t=>{
      const tag = t === 'すべて' ? '' : t;
      return `<button class="tag" data-tag="${tag}">${t}</button>`;
    }).join('');
    tagsEl.dataset.ready = '1';
  }
}

async function load(){
  try{
    // 1) posts ディレクトリの一覧
    const list = await j(`https://api.github.com/repos/${OWNER}/${REPO}/contents/posts?ref=${BRANCH}`);
    const files = list.filter(x => x.type==='file' && x.name.endsWith('.md'));
    if (!files.length) { showErr('posts フォルダに .md が見つかりません'); return; }

    // 2) 各 .md を取得 → フロントマター解析
    const result = [];
    for (const f of files) {
      const rawUrl = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/posts/${encodeURIComponent(f.name)}`;
      try {
        const md = await t(rawUrl);
        const {data, body} = parseFrontMatter(md);
        result.push({ name: f.name, data, body });
      } catch (e) {
        console.warn('fetch md failed:', f.name, e);
      }
    }
    allPosts = result;
    render();
  } catch (e) {
    showErr('記事一覧の取得に失敗しました。CSP/_headers またはファイル名/ブランチ設定を確認してください。');
    console.error(e);
  }
}

qEl.addEventListener('input', ()=>render());
tagsEl.addEventListener('click', e=>{
  const t = e.target.closest('[data-tag]'); if(!t) return;
  currentTag = t.dataset.tag || null;
  render();
});

load();
</script>
</body>
</html>