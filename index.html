<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>USMLE Japan Blog</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;line-height:1.6}
  header{padding:20px 16px;border-bottom:1px solid #e5e7eb}
  main{max-width:900px;margin:0 auto;padding:16px}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:12px 0}
  .meta{font-size:12px;color:#6b7280;margin-bottom:6px}
  .tag{display:inline-block;padding:2px 8px;border:1px solid #cbd5e1;border-radius:999px;font-size:12px;margin-right:6px}
  .err{background:#fff3f3;border:1px solid #f3c2c2;color:#b10707;padding:10px;border-radius:8px;margin:12px 0;white-space:pre-wrap}
  .ok{background:#f1fff3;border:1px solid #b8e7c0;color:#0a6d2f;padding:8px;border-radius:6px}
  a.btn{display:inline-block;padding:8px 12px;border:1px solid #0b63ce;border-radius:8px;color:#0b63ce;text-decoration:none}
</style>
</head>
<body>
<header>
  <main>
    <h1 style="margin:0 0 4px">USMLE Japan Blog</h1>
    <a class="btn" href="/admin/">管理画面</a>
  </main>
</header>

<main>
  <div id="diag" class="err" style="display:none"></div>
  <div id="list"></div>
</main>

<script>
const LIST_URL = '/posts/_list.json';

const listEl = document.getElementById('list');
const diagEl = document.getElementById('diag');

function showDiag(msg){
  diagEl.style.display = 'block';
  diagEl.textContent = msg;
}

async function head(url){
  const r = await fetch(url, { method:'HEAD', cache:'no-store' });
  return r.ok;
}
async function getText(url){
  const r = await fetch(url, { cache:'no-store' });
  if(!r.ok) throw new Error(`${r.status} ${url}`);
  return r.text();
}

function parseFrontMatter(mdRaw){
  const md = mdRaw.replace(/^\uFEFF/, '');
  const m = md.match(/^---\r?\n([\s\S]*?)\r?\n---\r?\n?/);
  if(!m) return { data:{}, body: md };
  const yaml = m[1], body = md.slice(m[0].length), data = {};
  yaml.split(/\r?\n/).forEach(line=>{
    const mm = line.match(/^([A-Za-z0-9_]+):\s*(.*)$/); if(!mm) return;
    const k = mm[1].trim(); let v = mm[2].trim();
    if (v === 'true') v = true;
    else if (v === 'false') v = false;
    else if (v.startsWith('[') && v.endsWith(']')) {
      try { v = JSON.parse(v.replace(/([^\s"',\[\]]+)/g,'"$1"')); } catch(e){}
    } else { v = v.replace(/^"(.*)"$/,'$1'); }
    data[k] = v;
  });
  return { data, body };
}

async function load(){
  const problems = [];
  // 1) _list.json の存在確認
  const listExists = await head(LIST_URL);
  if(!listExists){
    problems.push(`❌ ${LIST_URL} が見つかりません（ファイル名/場所を確認）`);
    showDiag(problems.join('\n'));
    return;
  }

  // 2) _list.json 取得
  let names = [];
  try {
    const txt = await getText(LIST_URL);
    names = JSON.parse(txt);
  } catch(e) {
    problems.push(`❌ ${LIST_URL} の読み込み/JSON解析に失敗: ${e.message}`);
    showDiag(problems.join('\n'));
    return;
  }
  if(!Array.isArray(names) || names.length === 0){
    problems.push(`❌ ${LIST_URL} に記事名が入っていません（例: ["hello.md"]）`);
    showDiag(problems.join('\n')); return;
  }

  // 3) 各 .md を同一オリジンで取得
  const posts = [];
  for(const name of names){
    const url = `/posts/${encodeURIComponent(name)}`;
    const exists = await head(url);
    if(!exists){
      problems.push(`❌ ${url} が見つかりません（_list.json の名前と実ファイル名を一致させてください）`);
      continue;
    }
    try{
      const md = await getText(url);
      const { data, body } = parseFrontMatter(md);
      posts.push({ name, data, body });
    }catch(e){
      problems.push(`❌ 取得失敗: ${url} → ${e.message}`);
    }
  }

  if(problems.length) showDiag(problems.join('\n'));

  // 4) 表示（draft: false のみ）
  const visible = posts.filter(p => !p.data.draft);
  visible.sort((a,b)=> (b.data.date||'').localeCompare(a.data.date||''));
  if(!visible.length){
    listEl.innerHTML = '<p>表示できる記事がありません（下書きのみか、取得失敗）。</p>';
    return;
  }
  listEl.innerHTML = visible.map(p=>`
    <article class="card">
      <div class="meta">${p.data.date||''} ${(p.data.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
      <h2 style="margin:.2em 0;"><a href="/post_view.html?path=/posts/${encodeURIComponent(p.name)}">${p.data.title||p.name}</a></h2>
      <p>${p.data.excerpt||''}</p>
    </article>
  `).join('');
  if(!problems.length){
    diagEl.style.display='block';
    diagEl.className='ok';
    diagEl.textContent='✅ 記事を読み込みました。';
  }
}

load().catch(e=>{
  showDiag('致命的エラー: '+ e.message);
  console.error(e);
});
</script>
</body>
</html>